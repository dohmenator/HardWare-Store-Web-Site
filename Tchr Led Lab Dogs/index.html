<html>

<head>
    <style>
        img {
            height: 60px;
            width: 60px
        }
    </style>
    <script>
        window.addEventListener("load", fetchDogs);

        function fetchDogs() {
            fetch("/Dog Inventory - Sheet1.csv")
                .then((response) => {
                    if (!response.ok) {
                        throw response.status;
                    }

                    return response.text();
                })
                .then((body) => body.split("\r\n"))
                .then((lines) => {
                    const headers = lines.shift().split(',');
                    const dogList = [];

                    for (const line of lines) {
                        const parts = line.split(',');
                        const dog = {};
                        for (let i = 0; i < parts.length; ++i) {
                            const column_name = headers[i];
                            dog[column_name] = parts[i];
                        }
                        dogList.push(dog);
                    }
                    return dogList;
                })
                .then(renderDogs)
                .then(createFilters)
                .then(console.log)
                .catch((err) => {
                    console.error("Didn't get dogs: " + err);
                });
        }

        // I'm not going to elaborate on this. The students should know enough
        // by now to turn this into something meaningful
        function renderDogs(list) {
            const container = document.getElementById('dogContainer');
            for (const i of list) {
                const div = document.createElement("div");

                div.appendChild(document.createTextNode(i.Name));

                const img = document.createElement("img");
                img.src = i.ImageFile;
                div.appendChild(img);

                container.appendChild(div);
            }
            // this line is important because it allows us to chain
            return list;
        }

        function createFilters(list) {
            const container = document.getElementById('filterContainer');
            const fn = createFilter.bind(null, list);
            Object.keys(list[0])
                .filter(key => key != 'Name' && key != 'ImageFile')
                .forEach(fn);
            // this line is important because it allows us to chain
            return list;
        }

        function createFilter(list, key) {
            var aggregate = {};
            for (var i of list) {
                aggregate[i[key]] = (aggregate[i[key]] || 0) + 1;
            }
            console.log(`Aggregate ${key}`);
            console.log(aggregate);
        }
    </script>
</head>

<body>
    <h1>Dohmen's Kennel Club</h1>
    <section id="filterContainer"></section>
    <section id="dogContainer"></section>
</body>

</html>